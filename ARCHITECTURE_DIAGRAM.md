# Архитектура проекта PathOfQuality

## 🏗️ Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                         app.py                              │
│                    (Точка входа)                            │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           v
┌─────────────────────────────────────────────────────────────┐
│                  src/core/application.py                    │
│              (Главный контроллер приложения)                │
│                                                             │
│  • Инициализация компонентов                               │
│  • Главный event loop                                       │
│  • Координация между модулями                              │
└───┬────────────┬────────────┬────────────┬─────────────────┘
    │            │            │            │
    │            │            │            │
    v            v            v            v
┌────────┐  ┌──────────┐  ┌─────────┐  ┌──────────────┐
│capture/│  │detector/ │  │  ui/    │  │   utils/     │
│        │  │          │  │         │  │              │
│• MSS   │  │• Template│  │• HUD    │  │• Settings   │
│        │  │• Library │  │• Mirrors│  │• Screen     │
└────────┘  └──────────┘  └─────────┘  │• ROI        │
                                        └──────────────┘
```

## 📦 Модульная структура

### 1. Слой утилит (utils/)

```
src/utils/
│
├── settings.py         Загрузка/сохранение настроек
│   ├── get_default_settings()
│   ├── load_settings()
│   └── save_settings()
│
├── screen.py           Работа с экраном
│   └── get_screen_size()
│
└── roi.py             Вычисление ROI
    └── compute_roi()
```

### 2. Слой ядра (core/)

```
src/core/
│
└── application.py      Главный класс приложения
    │
    ├── __init__()           Инициализация настроек
    ├── initialize()         Создание компонентов
    ├── run()               Главный event loop
    │
    ├── _handle_overlay_toggle()
    ├── _handle_positioning_toggle()
    ├── _handle_roi_selection()
    ├── _scan_frame()
    ├── _clear_results()
    └── _cleanup()
```

### 3. Слой UI (ui/)

```
src/ui/
│
├── styles.py                   Стили интерфейса
│   └── configure_modern_styles()
│
├── hud.py                     Главное окно
│   ├── BuffHUD класс
│   ├── Интеграция вкладок
│   └── Обработка событий
│
├── icon_mirrors.py            Зеркала иконок
│   └── IconMirrorsOverlay
│       ├── update()
│       ├── enable_positioning_mode()
│       └── disable_positioning_mode()
│
├── mirror_window.py           Отдельное окно
│   └── MirrorWindow
│       ├── show()
│       ├── hide()
│       ├── enable_positioning()
│       └── disable_positioning()
│
├── positioning.py             Логика позиционирования
│   └── PositioningHelper
│       └── create_snapper()
│
├── tabs/                      Вкладки
│   ├── monitoring_tab.py     Вкладка мониторинга
│   ├── settings_tab.py       Вкладка настроек
│   └── library_tab.py        Вкладка библиотеки
│
└── components/                Компоненты
    └── library_tree.py       TreeView компонент
```

## 🔄 Поток данных

### Сканирование и отображение

```
┌──────────────┐
│   MSS        │  1. Захват экрана
│   Capture    │
└──────┬───────┘
       │
       │ frame (BGR)
       v
┌──────────────┐
│  Template    │  2. Поиск шаблонов
│  Matcher     │
└──────┬───────┘
       │
       │ matches
       v
┌──────────────┐
│   Library    │  3. Поиск в библиотеке
│   Matcher    │
└──────┬───────┘
       │
       │ results
       v
┌──────────────────────────┐
│     BuffHUD              │  4. Обновление UI
│  ┌────────────────────┐  │
│  │ MonitoringTab      │  │
│  │ (показать иконки)  │  │
│  └────────────────────┘  │
└──────────────────────────┘
       │
       │ results + frame
       v
┌──────────────────────────┐
│  IconMirrorsOverlay      │  5. Зеркала иконок
│  ┌────────────────────┐  │
│  │ MirrorWindow × N   │  │  Вырезаем найденные
│  │ (overlay windows)  │  │  области и показываем
│  └────────────────────┘  │
└──────────────────────────┘
```

### Event Loop

```
┌─────────────────────────────────────────────────────┐
│            Application.run()                        │
│                                                     │
│  while True:                                        │
│    ┌──────────────────────────────────────────┐   │
│    │ event = hud.read(timeout)                │   │
│    └────────────────┬─────────────────────────┘   │
│                     │                              │
│    ┌────────────────┴────────────────┐            │
│    │                                 │            │
│    v                                 v            │
│  EXIT?                          SELECT_ROI?       │
│  ├─> break                      ├─> select_roi()  │
│                                                    │
│    v                                 v            │
│  LIBRARY_UPDATED?              POSITIONING?       │
│  ├─> refresh matchers          ├─> toggle mode   │
│                                                    │
│    v                                              │
│  if scanning_enabled:                            │
│    ├─> capture frame                             │
│    ├─> match templates                           │
│    ├─> update hud                                │
│    └─> update mirrors                            │
│  else:                                            │
│    └─> clear results                             │
│                                                   │
└───────────────────────────────────────────────────┘
```

## 🎨 UI Компоненты

### BuffHUD (главное окно)

```
┌─────────────────────────────────────────────────┐
│              BuffHUD Window                     │
├─────────────────────────────────────────────────┤
│  ┌───┬───────┬───────┬─────────┐              │
│  │ M │   S   │   B   │    D    │  Tabs        │
│  └───┴───────┴───────┴─────────┘              │
│                                                 │
│  ┌───────────────────────────────────────┐    │
│  │  MonitoringTab                        │    │
│  │  ┌─────────────────────────────────┐ │    │
│  │  │ ✓ Positioning                   │ │    │
│  │  │                                 │ │    │
│  │  │ [icon] [icon] [icon]           │ │    │
│  │  │                                 │ │    │
│  │  │ [Scan] ● Scanning...           │ │    │
│  │  │                                 │ │    │
│  │  │ Найдены: buff1, buff2          │ │    │
│  │  │                                 │ │    │
│  │  │ [Exit]                         │ │    │
│  │  └─────────────────────────────────┘ │    │
│  └───────────────────────────────────────┘    │
└─────────────────────────────────────────────────┘
     M = Monitoring  S = Settings
     B = Buffs       D = Debuffs
```

### LibraryTreeView (компонент)

```
┌───────────────────────────────────────────────────┐
│  [Add] [Edit]                                     │
│  Search: [_____________] [Clear]                  │
├───────────────────────────────────────────────────┤
│  Icon │ Name      │ Activate    │ Description   │
├───────┼───────────┼─────────────┼───────────────┤
│  [🛡] │ Shield    │ ☑ Activate  │ Защита от ... │
│  [⚔] │ Sword     │ ☐ Activate  │ Увеличение... │
│  [💫] │ Speed     │ ☑ Activate  │ Ускорение ... │
└───────────────────────────────────────────────────┘
```

## 🔌 Зависимости модулей

```
app.py
  └─> core/application.py
      ├─> utils/settings.py
      ├─> utils/screen.py
      ├─> utils/roi.py
      ├─> capture/mss_capture.py
      ├─> detector/template_matcher.py
      ├─> detector/library_matcher.py
      ├─> ui/hud.py
      │   ├─> ui/styles.py
      │   ├─> ui/tabs/monitoring_tab.py
      │   ├─> ui/tabs/settings_tab.py
      │   ├─> ui/tabs/library_tab.py
      │   │   └─> ui/components/library_tree.py
      │   └─> ui/dialogs/buff_editor.py
      ├─> ui/icon_mirrors.py
      │   ├─> ui/mirror_window.py
      │   └─> ui/positioning.py
      ├─> ui/overlay.py
      ├─> ui/roi_selector.py
      └─> ui/tray.py
```

## 📊 Сравнение архитектур

### Старая архитектура (монолит)

```
┌────────────────────────────────┐
│         app.py                 │
│  ┌──────────────────────────┐ │
│  │ Всё вместе:              │ │
│  │ • Настройки              │ │
│  │ • ROI                    │ │
│  │ • Захват                 │ │
│  │ • Детекция               │ │
│  │ • UI                     │ │
│  │ • Event loop             │ │
│  └──────────────────────────┘ │
└────────────────────────────────┘

┌────────────────────────────────┐
│         hud.py                 │
│  ┌──────────────────────────┐ │
│  │ 947 строк:               │ │
│  │ • Стили                  │ │
│  │ • Все вкладки            │ │
│  │ • TreeView               │ │
│  │ • Обработчики            │ │
│  │ • Позиционирование       │ │
│  └──────────────────────────┘ │
└────────────────────────────────┘
```

### Новая архитектура (модульная)

```
┌──────────┐
│  app.py  │ (20 строк)
└────┬─────┘
     │
     v
┌─────────────────────────────────┐
│  core/application.py            │
│  (Координатор)                  │
└─┬───┬───┬───┬───┬───┬───┬───┬──┘
  │   │   │   │   │   │   │   │
  v   v   v   v   v   v   v   v
┌────────────────────────────────┐
│  Специализированные модули     │
│  по ~150 строк каждый          │
└────────────────────────────────┘
```

## 🎯 Принципы разделения

### 1. По слоям (Layered Architecture)

```
┌─────────────────────────────┐
│     Presentation Layer      │  ui/
│  (Интерфейс пользователя)   │
├─────────────────────────────┤
│     Business Logic Layer    │  core/
│  (Логика приложения)        │
├─────────────────────────────┤
│     Data Access Layer       │  buffs/
│  (Работа с данными)         │
├─────────────────────────────┤
│     Utility Layer           │  utils/
│  (Общие функции)            │
└─────────────────────────────┘
```

### 2. По функциональности (Feature-based)

```
ui/
├── tabs/           # Каждая вкладка = отдельный модуль
├── components/     # Переиспользуемые компоненты
└── dialogs/        # Диалоговые окна
```

### 3. По ответственности (SRP)

```
Один модуль = одна задача

✅ settings.py  → только настройки
✅ screen.py    → только экран  
✅ roi.py       → только ROI
```

## 💡 Расширение системы

### Добавление новой функции

```
Новая вкладка "Statistics":

1. Создать модуль
   src/ui/tabs/statistics_tab.py

2. Создать класс
   class StatisticsTab:
       def __init__(self, parent): ...

3. Зарегистрировать в HUD
   self._stats_tab = StatisticsTab(...)
   self._notebook.add(..., text="Stats")

Готово! ✅
```

## 📈 Преимущества новой архитектуры

### 1. Масштабируемость
- Легко добавить новый модуль
- Не затрагиваем существующий код

### 2. Тестируемость
- Можно тестировать каждый модуль отдельно
- Легко мокировать зависимости

### 3. Читаемость
- Понятная структура папок
- Файлы по 150-250 строк
- Чёткие названия

### 4. Поддерживаемость
- Легко найти код
- Изменения локализованы
- Меньше побочных эффектов

---

**Архитектура: Модульная, слоистая, масштабируемая** ✨

